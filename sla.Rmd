---
title: "Mapas (Leaflet)"
author: "Nathália Lobo, Pedro Paulo, André Fernandes e Pedro Eros"
date: "10/08/2022"
output:
  slidy_presentation: default
  ioslides_presentation: default
  beamer_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(leaflet)
```

## Instalação e habilitação

```{r}
# install.packages("leaflet")
library(leaflet)
```

- Exemplo

```{r}
map <- leaflet() %>% 
  addTiles() %>% 
  addMarkers(lng = 174.768, lat = -36.852, popup = "The birthplace of R")
map
```


## Markets

- São marcadores feito por coordenadas (longitude e latitude)
- Adicionam ícones ou círculos aos mapas 

### AddMarkers()
- principal função para criar ícones

### addCircles
- principal função para criar círculos 


## Quakes
- Data frame com 1000 observações em 5 variáveis
- latitude, longitude, profundidade (km), magnitude, número de relatórios de estações
- Esse conjunto de dados fornece as localizações de 1000 eventos sísmicos com magnitude acima de 4, que foram coletados perto de Fiji (arquipélago com mais de 300 ilhas)
- Para mais informações sobre o data frame [clique aqui](https://stat.ethz.ch/R-manual/R-devel/library/datasets/html/quakes.html)

```{r message=F, warning=F, error=F, echo = FALSE}
data(quakes)
head(quakes)
```


## addMarkers

### addMarkers(lng, lat, popup, label)
- Adiciona ícone por default

```{r}
leaflet(data = quakes[1:6,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat)
```

## makeIcon
- Com ela possível alterar esses ícones por link ou imagem presente no computador e afins

```{r eval=FALSE}
leaflet_Icon <- makeIcon(
  iconUrl = "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
  iconWidth = 25, iconHeight = 50,
  iconAnchorX = 1, iconAnchorY = 45
)

leaflet(data = quakes[1:6,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = leaflet_Icon)
```

## addMarkers

```{r echo=FALSE}
leaflet_Icon <- makeIcon(
  iconUrl = "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
  iconWidth = 25, iconHeight = 50,
  iconAnchorX = 1, iconAnchorY = 45
)

leaflet(data = quakes[1:6,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = leaflet_Icon)
```

## Múltiplos ícones
- Usa-se *icons()* para todos possuirem o mesmo tamanho e pontos de ancoragem

```{r eval=FALSE}
leaflet_Icons <- icons(
  iconUrl = 
    ifelse(quakes[1:10,]$mag < 4.6,
           "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
           "http://clubedefinancas.com.br/wp-content/uploads/2018/04/map-marker-icon.png"
  ),
  iconWidth = 25, iconHeight = 50,
  iconAnchorX = 13, iconAnchorY = 54)

leaflet(data = quakes[1:10,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = leaflet_Icons)
```

## Múltiplos ícones

```{r echo=FALSE}
leaflet_Icons <- icons(
  iconUrl = 
    ifelse(quakes[1:10,]$mag < 4.6,
           "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
           "http://clubedefinancas.com.br/wp-content/uploads/2018/04/map-marker-icon.png"
  ),
  iconWidth = 25, iconHeight = 50,
  iconAnchorX = 13, iconAnchorY = 54)

leaflet(data = quakes[1:10,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = leaflet_Icons)
```

## Múltiplos ícones
- Usa-se *iconList()* para criar uma lista, em que os parâmetros são diferentes

```{r eval=FALSE}
icon_data <- iconList(
  red = makeIcon(
    iconUrl = "http://clubedefinancas.com.br/wp-content/uploads/2018/04/map-marker-icon.png",
    iconWidth = 23, iconHeight = 38),
  green = makeIcon(
    iconUrl = "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
    iconWidth = 32, iconHeight = 28)
)

quakes_2 <- mutate(quakes, 
                   type = factor(ifelse(quakes$mag < 4.6, "green", "red")))

leaflet(data = quakes_2[1:10,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = ~icon_data[type])
```

## Múltiplos ícones
```{r echo=FALSE}
icon_data <- iconList(
  red = makeIcon(
    iconUrl = "http://clubedefinancas.com.br/wp-content/uploads/2018/04/map-marker-icon.png",
    iconWidth = 23, iconHeight = 38),
  green = makeIcon(
    iconUrl = "https://icons.iconarchive.com/icons/shlyapnikova/toolbar-2/32/pin-icon.png",
    iconWidth = 32, iconHeight = 28)
)

quakes_2 <- mutate(quakes, 
                   type = factor(ifelse(quakes$mag < 4.6, "green", "red")))

leaflet(data = quakes_2[1:10,]) %>% 
  addTiles() %>%
  addMarkers(~long, ~lat, icon = ~icon_data[type])
```

## Awesome Icons
- Principais funções *addAwesomeMarkers()*, *makeAwesomeIcon()*, *awesomeIcons()*, *awesomeIconList()*
- Similar as anteriores, mas agora pode customizar cores e ícones 
- Como com ícones das bibliotecas: `Font Awesome`, `Bootstrap Glyphicons`, e `Ion icons`

```{r eval=FALSE}
icon_fa <- makeAwesomeIcon(
  icon = "exclamation", markerColor = "orange",
  library = "fa", iconColor = "black")

leaflet(data = quakes[1:10,]) %>% 
  addTiles() %>%
  addAwesomeMarkers(~long, ~lat, icon =icon_fa )
```

## Awesome Icons

```{r echo=FALSE}
icon_fa <- makeAwesomeIcon(
  icon = "exclamation", markerColor = "orange",
  library = "fa", iconColor = "black")

leaflet(data = quakes[1:10,]) %>% 
  addTiles() %>%
  addAwesomeMarkers(~long, ~lat, icon =icon_fa )
```


## Tópicos

- Bullet 1 `teste`
- Bullet 2  *italico*
- Bullet 3  **sla**
- para mais [Wikipédia](https://pt.wikipedia.org/wiki/Equação_quadrática)

## GeoJSON/TopoJSON
- Para trabalhar com dados GeoJSON/TopoJSON existem duas opções:ler os dados
como objetos sp (spatial data); ou usando as funções addGeoJSON() e addTopoJSON().
- O geoJSON formato para codificar uma variedades de dados geográficos. 
- O topoJSON formato para codificar uma variedades de dados topográficos.

```{echo echo=TRUE, =}
# municípios de nova york
nycounties <- 
  rgdal::readOGR("https://rstudio.github.io/leaflet/json/nycounties.geojson")
pal <- colorNumeric("viridis", NULL)

leaflet(nycounties) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1,
              fillColor = ~pal(log10(pop)),
              label = ~paste0(county, ": ", formatC(pop, big.mark = ","))) %>%
  addLegend(pal = pal, values = ~log10(pop), opacity = 1.0,
            labFormat = labelFormat(transform = function(x) round(10^x)))

```

## Lendo com TopoJSON

```{echo echo=TRUE, =}
topoData <- 
  readLines("https://rstudio.github.io/leaflet/json/us-10m.json") %>% 
  paste(collapse = "\n")

leaflet() %>% 
  setView(lng = -98.583, lat = 39.833, zoom = 3) %>%
  addTiles() %>%
  addTopoJSON(topoData, weight = 1, color = "#444444", fill = FALSE)
```

## Podemos modificar o estilo do GeoJSON e do TopoJSON de algumas maneiras.
Como aplicando argumentos direto nas funções addGeoJSON / addTopoJSON.

```{r}
install.packages("jsonlite")
library(jsonlite)

geojson <- readLines("https://rstudio.github.io/leaflet/json/countries.geojson", warn = FALSE) %>%
  paste(collapse = "\n") %>%
  fromJSON(simplifyVector = FALSE)

# Estilo padrão para todos recursos
geojson$style = list(
  weight = 1,
  color = "#555555",
  opacity = 1,
  fillOpacity = 0.8
)

# Junta o PIB de todos países
gdp_md_est <- sapply(geojson$features, function(feat) {
  feat$properties$gdp_md_est
})
# Junta a população estimada de todos países
pop_est <- sapply(geojson$features, function(feat) {
  max(1, feat$properties$pop_est)
})

# Cor por PIB per-capita usando quantis

pal <- colorQuantile("Greens", gdp_md_est / pop_est)
# adiciona properties$style pra cada recurso

geojson$features <- lapply(geojson$features, function(feat) {
  feat$properties$style <- list(
    fillColor = pal(
      feat$properties$gdp_md_est / max(1, feat$properties$pop_est)
    )
  )
  feat
})

# adiciona o GeoJSON pro mapa
leaflet() %>% 
  addGeoJSON(geojson)
```

